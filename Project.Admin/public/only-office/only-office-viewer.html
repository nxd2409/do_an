<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>OnlyOffice Viewer</title>
  <style>
    html,
    body {
      margin: 0;
      height: 100%;
      background-color: white;
    }

    #placeholder {
      width: 100%;
      height: 90vh;
    }

    .extra #header-logo {
      display: none !important;
    }
  </style>
</head>

<body>
  <div id="placeholder"></div>
  <script>
    let docEditor = null, currentFileId = null, currentType = 1, currentIdTab = null;
    const pad = n => n.toString().padStart(2, '0');
    const generateUniqueKey = () => {
      const d = new Date();
      return [
        d.getFullYear(),
        pad(d.getMonth() + 1),
        pad(d.getDate()),
        pad(d.getHours()),
        pad(d.getMinutes()),
        pad(d.getSeconds()),
        d.getMilliseconds()
      ].join('');
    };

    const detectFileType = (fileName) => {
      const extension = fileName.split('.').pop().toLowerCase();
      const wordFormats = ['doc', 'docx', 'docm', 'dot', 'dotx', 'dotm', 'odt', 'fodt', 'ott', 'rtf', 'txt', 'html', 'htm', 'mht', 'pdf', 'djvu', 'fb2', 'epub', 'xps', 'bm3'];
      const cellFormats = ['xls', 'xlsx', 'xlsm', 'xlt', 'xltx', 'xltm', 'ods', 'fods', 'ots', 'csv'];
      const slideFormats = ['ppt', 'pptx', 'pptm', 'pot', 'potx', 'potm', 'odp', 'fodp', 'otp'];

      let documentType = 'word';
      let fileType = extension;

      if (wordFormats.includes(extension)) {
        documentType = 'word';
      } else if (cellFormats.includes(extension)) {
        documentType = 'cell';
      } else if (slideFormats.includes(extension)) {
        documentType = 'slide';
      }

      if (extension === 'txt') {
        fileType = 'txt';
      } else if (extension === 'csv') {
        fileType = 'csv';
      } else if (extension == 'bm3') {
        fileType = 'docx'
      }

      return { documentType, fileType };
    };

    const loadOnlyOfficeScript = (onlyOfficeUrl) => {
      return new Promise((resolve, reject) => {
        if (window.DocsAPI) {
          resolve();
          return;
        }

        const timestamp = new Date().getTime();
        const script = document.createElement('script');
        script.src = `${onlyOfficeUrl}/web-apps/apps/api/documents/api.js?t=${timestamp}`;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    };

    const manualSaveFileOnlyOffice = () => docEditor.downloadAs();

    window.addEventListener("message", e => {
      try {
        const data = e?.data;
        if (!data?.file && !data?.action) return;

        if (data.action === 'getEditedOnlyOffice') {
          manualSaveFileOnlyOffice();
          return;
        }

        const { file, mode = "edit", environment, type, onlyOfficeUrl, idTab } = data;
        const url = decodeURIComponent(`${environment}/File/Download/${file.id}`);
        const fileName = file.fileName || url.split('/').pop();
        const saveUrl = `${environment}/OnlyOffice/CallbackWithoutError`;

        currentFileId = file.id;
        currentType = type;
        currentIdTab = idTab;

        if (!onlyOfficeUrl) {
          window.parent.postMessage({ action: 'returnEditOnlyOffice', message: 'Thiếu cấu hình onlyOfficeUrl!' }, '*');
          return;
        }

        const { documentType, fileType } = detectFileType(fileName);

        loadOnlyOfficeScript(onlyOfficeUrl).then(() => {
          docEditor = new DocsAPI.DocEditor("placeholder", {
            width: "100%",
            height: "100%",
            documentType: documentType,
            type: "desktop",
            document: {
              fileType: fileType,
              key: generateUniqueKey(),
              title: fileName,
              url
            },
            editorConfig: {
              mode,
              lang: "en",
              callbackUrl: mode === "edit" ? saveUrl : "",
              user: {
                id: "onlyOffice",
                name: "Only Office"
              },
              customization: {
                compactToolbar: false,
                toolbarNoTabs: false,
                statusBar: true,
                autosave: false,
                forcesave: false,
                comments: false,
                showReviewChanges: false,
                spellcheck: false,
                zoom: 80,
                hideRightMenu: true,
                hideLeftMenu: true,
                hideToolbar: false,
                uiTheme: "classic",
                logo: {
                  image: "",
                  url: "",
                }
              },
              permissions: {
                edit: mode === "edit",
                download: true,
                print: true,
                review: mode === "edit",
                comment: mode === "edit",
                fillForms: mode === "edit",
                modifyFilter: mode === "edit",
                modifyContentControl: mode === "edit",
                copy: true,
                chat: false
              }
            },
            events: {
              onDownloadAs: e => {
                const fileUrl = e?.data?.url;
                if (!fileUrl || !currentFileId || !currentType) return;

                fetch(`${environment}/OnlyOffice/SaveFile`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${data.token}`
                  },
                  body: JSON.stringify({
                    fileId: currentFileId,
                    url: fileUrl,
                    type: currentType
                  })
                })
                  .then(r => {
                    if (r.ok) {
                      return r.json();
                    } else {
                      return r.json().catch(() => ({ status: false, message: 'Lưu file thất bại!' }))
                        .then(errorBody => ({ status: false, message: errorBody.message || 'Lưu file thất bại!' }));
                    }
                  })
                  .catch(error => {
                    console.error("Fetch error in iframe:", error);
                    return { status: false, message: error.toString() || 'Có lỗi xảy ra khi lưu file!' };
                  })
                  .then(responseObject => {
                    window.parent.postMessage({
                      action: 'returnEditOnlyOffice',
                      data: responseObject,
                      idTab: currentIdTab
                    }, '*');
                  });
              },
              onError: (event) => {
                console.error("OnlyOffice Error:", event);
                window.parent.postMessage({
                  action: 'returnEditOnlyOffice',
                  message: `Lỗi khi mở file: ${event.data}`
                }, '*');
              }
            }
          });
        }).catch(err => {
          console.error("Error loading OnlyOffice script:", err);
          window.parent.postMessage({ action: 'returnEditOnlyOffice', message: 'Không thể tải OnlyOffice API!' }, '*');
        });
      } catch (err) {
        console.error("Error opening file:", err);
        window.parent.postMessage({ action: 'returnEditOnlyOffice', message: 'Có lỗi trong quá trình mở file!' }, '*');
      }
    });
  </script>
</body>

</html>