<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jitsi Meet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
        }

        #jitsi-container {
            width: 100vw;
            height: 100dvh;
        }
    </style>
</head>

<body>
    <div id="jitsi-container"></div>
    <script>
        let jitsiAPI = null;
        let jitsiScriptUrl = null;

        const urlParams = new URLSearchParams(window.location.search);
        jitsiScriptUrl = urlParams.get('scriptUrl');

        window.addEventListener('message', function (event) {
            const { type, data, serverCallback } = event.data;
            if (type === 'INIT_JITSI') {
                initJitsi(data);
                return;
            }
            if (!jitsiAPI) return;

            switch (type) {
                case 'TOGGLE_AUDIO':
                    jitsiAPI.executeCommand('toggleAudio');
                    break;
                case 'TOGGLE_VIDEO':
                    jitsiAPI.executeCommand('toggleVideo');
                    break;
                case 'TOGGLE_SCREEN_SHARE':
                    jitsiAPI.executeCommand('toggleShareScreen');
                    break;
                case 'TOGGLE_CHAT':
                    jitsiAPI.executeCommand('toggleChat');
                    break;
                case 'TOGGLE_TILE_VIEW':
                    jitsiAPI.executeCommand('toggleTileView');
                    break;
                case 'HANG_UP':
                    jitsiAPI.executeCommand('hangup');
                    break;
                case 'MUTE_EVERYONE':
                    jitsiAPI.executeCommand('muteEveryone');
                    break;
                case 'START_RECORDING':
                    jitsiAPI.executeCommand('startRecording', {
                        mode: 'file',
                        shouldShare: false,
                        transcription: false,
                        extraMetadata: {
                            title: `${data.id}+ServerURL:${serverCallback}`,
                        },
                    });
                    break;
                case 'STOP_RECORDING':
                    jitsiAPI.executeCommand('stopRecording', 'file');
                    break;

                case 'MUTE_AUDIO':
                    jitsiAPI.isAudioMuted().then(muted => {
                        if (!muted) jitsiAPI.executeCommand('toggleAudio');
                    });
                    break;

                case 'UNMUTE_AUDIO':
                    jitsiAPI.isAudioMuted().then(muted => {
                        if (muted) jitsiAPI.executeCommand('toggleAudio');
                    });
                    break;

                case 'MUTE_VIDEO':
                    jitsiAPI.isVideoMuted().then(muted => {
                        if (!muted) jitsiAPI.executeCommand('toggleVideo');
                    });
                    break;

                case 'UNMUTE_VIDEO':
                    jitsiAPI.isVideoMuted().then(muted => {
                        if (muted) jitsiAPI.executeCommand('toggleVideo');
                    });
                    break;
            }
        });

        function initJitsi(config) {
            if (typeof JitsiMeetExternalAPI === 'undefined') {
                window.parent.postMessage({ type: 'JITSI_ERROR', error: 'JitsiMeetExternalAPI not loaded' }, '*');
                return;
            }

            const options = {
                roomName: config.roomName,
                width: '100%',
                height: '100%',
                parentNode: document.getElementById('jitsi-container'),
                userInfo: {
                    displayName: config.displayName || 'Người dùng',
                    email: config.email || ''
                },
                configOverwrite: {
                    prejoinConfig: { enabled: false },
                    prejoinPageEnabled: false,
                    enablePrejoinPage: false,
                    requireDisplayName: false,
                    startWithAudioMuted: true,
                    startWithVideoMuted: true,
                    disableDeepLinking: true,
                    disableInviteFunctions: true,
                    enableWelcomePage: false,
                    enableClosePage: false,
                    disableProfile: true,
                    hideConferenceSubject: true,
                    hideConferenceTimer: true,
                    hideParticipantsStats: true,
                    fileRecordingsEnabled: false,
                    liveStreamingEnabled: false,
                    disableRemoteMute: false,
                    notifications: [],
                    toolbarButtons: []
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: [],
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    SHOW_BRAND_WATERMARK: false,
                    SHOW_POWERED_BY: false,
                    DEFAULT_BACKGROUND: '#2e2e2e',
                    MOBILE_APP_PROMO: false,
                    HIDE_INVITE_MORE_HEADER: true,
                    filmStripOnly: false,
                    DISABLE_TRANSCRIPTION_SUBTITLES: true,
                    DISABLE_VIDEO_BACKGROUND: true,
                    DISABLE_FOCUS_INDICATOR: true,
                    DISABLE_DOMINANT_SPEAKER_INDICATOR: true,
                    HIDE_PREJOIN_SCREEN: true
                }
            };

            try {
                jitsiAPI = new JitsiMeetExternalAPI(config.domain, options);

                setTimeout(() => {
                    try {
                        jitsiAPI.executeCommand('toggleLobby', false);
                        jitsiAPI.executeCommand('startRecording', { mode: 'stream' });
                        jitsiAPI.executeCommand('cancelPrivateChat');
                    } catch (e) { }
                    const joinButton = document.querySelector('[data-testid="prejoin.joinMeeting"]');
                    if (joinButton) joinButton.click();
                }, 300);

                setupEventListeners();
                window.parent.postMessage({ type: 'JITSI_READY' }, '*');
            } catch (error) {
                window.parent.postMessage({ type: 'JITSI_ERROR', error: error.message }, '*');
            }
        }

        function setupEventListeners() {
            jitsiAPI.addListener('videoConferenceJoined', () => {
                window.parent.postMessage({
                    type: 'PARTICIPANT_COUNT_CHANGED',
                    count: jitsiAPI.getNumberOfParticipants()
                }, '*');
            });

            jitsiAPI.addListener('participantJoined', () => {
                window.parent.postMessage({
                    type: 'PARTICIPANT_COUNT_CHANGED',
                    count: jitsiAPI.getNumberOfParticipants()
                }, '*');
            });

            jitsiAPI.addListener('participantLeft', () => {
                window.parent.postMessage({
                    type: 'PARTICIPANT_COUNT_CHANGED',
                    count: jitsiAPI.getNumberOfParticipants()
                }, '*');
            });

            jitsiAPI.addListener('audioMuteStatusChanged', (data) => {
                window.parent.postMessage({
                    type: 'AUDIO_MUTE_CHANGED',
                    muted: data.muted
                }, '*');
            });

            jitsiAPI.addListener('videoMuteStatusChanged', (data) => {
                window.parent.postMessage({
                    type: 'VIDEO_MUTE_CHANGED',
                    muted: data.muted
                }, '*');
            });

            jitsiAPI.addListener('screenSharingStatusChanged', (data) => {
                window.parent.postMessage({
                    type: 'SCREEN_SHARE_CHANGED',
                    on: data.on
                }, '*');
            });

            jitsiAPI.addListener('tileViewChanged', (data) => {
                window.parent.postMessage({
                    type: 'TILE_VIEW_CHANGED',
                    enabled: data.enabled
                }, '*');
            });

            jitsiAPI.addListener('recordingStatusChanged', (data) => {
                window.parent.postMessage({
                    type: 'RECORDING_STATUS_CHANGED',
                    mode: data.mode,
                    on: data.on,
                    participantId: data.participant?.id || null
                }, '*');
            });

            jitsiAPI.addListener('recordingLinkAvailable', (data) => {
                window.parent.postMessage({
                    type: 'RECORDING_LINK_AVAILABLE',
                    link: data.link
                }, '*');
            });

            jitsiAPI.addListener('recordingStopped', (data) => {
                window.parent.postMessage({
                    type: 'RECORDING_STOPPED',
                    data
                }, '*');
            });
        }

        if (jitsiScriptUrl) {
            const script = document.createElement('script');
            script.src = decodeURIComponent(jitsiScriptUrl);
            script.async = true;
            script.onload = () => {
                window.parent.postMessage({ type: 'JITSI_SCRIPT_LOADED' }, '*');
            };
            script.onerror = () => {
                window.parent.postMessage({ type: 'JITSI_SCRIPT_ERROR' }, '*');
            };
            document.head.appendChild(script);
        }
    </script>
</body>

</html>